#!/bin/bash
#-----------------------------------------------------------------------------------------
# Copies de seguretat de l'ordinador nuvolet (Raspberry Pi) amb FreeBSD al meu Dropbox
# Iniciat 2 de juliol 2016
# joan@riseup.net
# http://github.com/joancatala
#-----------------------------------------------------------------------------------------


echo "
██████╗ ██████╗ ██████╗ ██╗ █████╗ ██████╗  ██████╗ ██████╗
██╔════╝██╔═══██╗██╔══██╗██║██╔══██╗██╔══██╗██╔═══██╗██╔══██╗
██║     ██║   ██║██████╔╝██║███████║██║  ██║██║   ██║██████╔╝
██║     ██║   ██║██╔═══╝ ██║██╔══██║██║  ██║██║   ██║██╔══██╗
╚██████╗╚██████╔╝██║     ██║██║  ██║██████╔╝╚██████╔╝██║  ██║
 ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚═╝  ╚═╝╚═════╝  ╚═════╝ ╚═╝  ╚═╝
"

# Missatge 1
echo -e "\e[34m----------------------------------------------------------------------------"
echo -e "\e[34mIniciem l'aplicació Copiador per a pujar fitxers de configuracio a Dropbox"
echo -e "\e[34m----------------------------------------------------------------------------"

# Preparem l'entorn de la còpia
cd $HOME
NOW=$(date +"%Y%m%d")
mkdir $NOW
cd $NOW

# Missatge 2
echo -e "\e[34mAnem a copiar els fitxers"

# Copiem els fitxers que volem del nostre servidor FreeBSD nuvolet.benicass.im
# Ací pots afegir lliurement tots els fitxers que necessites mantenir segurs al núvol Dropbox.
cp /etc/rc.conf .
cp /boot/loader.conf .
cp /etc/sysctl.conf .
cp /usr/local/etc/php-fpm.conf .
cp /usr/local/etc/php/extensions.ini .
cp -rf /usr/local/etc/nginx/ .
cp -rf /var/www .

# Generem dos fitxers informatius amb totes les apliacions instal·lades a l'ordinador
# i amb versio, kernel, espai en disc:aplicacions_instalades.txt, configuracio_ordinador.txt i el Crontab
echo -e "######################################################################################################\nAplicacions instal·lades\n######################################################################################################" > aplicacions_instalades.txt && echo -e "  \n\n" >> configuracio_ordinador.txt && pkg info >> aplicacions_instalades.txt

echo -e "######################################################################################################\nKernel\n######################################################################################################" > configuracio_ordinador.txt && uname -a >> configuracio_ordinador.txt && echo -e "  \n\n" >> configuracio_ordinador.txt && echo -e "######################################################################################################\nVersió de FreeBSD\n######################################################################################################" >> configuracio_ordinador.txt && freebsd-version >> configuracio_ordinador.txt && echo -e "  \n \n" >> configuracio_ordinador.txt && echo -e "######################################################################################################\nEspai en disc\n######################################################################################################" >> configuracio_ordinador.txt && df -h >> configuracio_ordinador.txt && echo -e "  \n\n" >> configuracio_ordinador.txt && echo -e "######################################################################################################\nCrontab\n######################################################################################################" >> configuracio_ordinador.txt && crontab -l >> configuracio_ordinador.txt && echo -e "  \n\n"

# Eixim i fem el tar.gz amb:
cd ..
tar cvfz $NOW.copia.tar.gz $NOW/

# Missatge 3
sleep 2
echo -e "\e[32mFitxers copiats, ara anem a procedir a pujar-los al Dropbox..."

# Finalment iniciem l'ordre de pujada al meu Dropbox
dropbox_uploader.sh upload ./$NOW.copia.tar.gz /software/backups/nuvolet/

# Missatge 4
sleep 2
echo -e "\e[34mLa còpia de seguretat ja ha segut pujada a Dropbox!"

# Esborrem el directori del backup perquè ja el tenim a Dropbox
rm -rf $NOW
rm -rf $NOW.copia.tar.gz

# Esperem els cinc segons i netejem la consola
sleep 5
echo -e "\e[34mLa còpia al nuvolet ha finalitzat."
echo -e "\e[39m "
# Fi
